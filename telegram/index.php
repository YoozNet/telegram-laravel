<?php

header('Content-Type: application/json; charset=utf-8');
ini_set('error_log', '0.txt');
error_reporting(E_ALL);

include_once("boot.php");

$update = new TelegramUpdates();

if($update->text == "/start" || (isset($update->text) && explode(" ", $update->text)[0] == "/start")) {
    $existing_user = Database::select("YN_users", ["id"], "user_id = ?", [$update->chat_id]);
    if ($existing_user) {
        Telegram::api('sendMessage',[
            'chat_id' => $update->chat_id,
            'text' => "ุฏุฑูุฏ! ๐
ุจู ุฑุจุงุช ุชูฺฏุฑุงู ูุฒูุช ุฎูุด ุขูุฏุฏ. ุจุง ุงุณุชูุงุฏู ุงุฒ ุฏฺฉููโูุง ุฒุฑ ูโุชูุงูุฏ ุจุง ุณุฑูุณโูุง VPN ูุง ุขุดูุง ุดูุฏ ู ุจู ุตูุฑุช ูุงุดูุงุณ ุฏุฑ ุงูุชุฑูุช ฺฏุดุช ู ฺฏุฐุงุฑ ฺฉูุฏ ! ๐ฅท๐ป
ฺฉุงู ุงุณุช ฺฉ ุงุฒ ฺฏุฒููโูุง ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ ู ุชุฌุฑุจู ุฌุฏุฏ ุฎูุฏ ุฑุง ุขุบุงุฒ ฺฉูุฏ! ๐๐"
        ]);
    } else {
        $parts = explode(" ", $update->text);
        $referral_code = isset($parts[1]) ? $parts[1] : null;
        if ($referral_code) {
            $referrer = Database::select("YN_users", ["*"], "referral_id = ?", [$referral_code]);
            if ($referrer) {
                createUser($update->chat_id);
                $referrer_chat_id = $referrer[0]['user_id'];
                Telegram::api('sendMessage',[
                    'chat_id' => $update->chat_id,
                    'text' => "ุดูุง ุจู ูพุดููุงุฏ ฺฉ ุฏูุณุช ูุงุจูโุงุนุชูุงุฏ ุ ุจู ุฎุงููุงุฏู ูุฒูุช ูพูุณุชุฏ!  ๐๐ท
ุงุฒ ุญุงูุง ูโุชูุงูุฏ ุงุฒ ุฎุฏูุงุช ุญุฑููโุง ฺฉุงูุด ูพูฺฏ ูุง ูุฐุช ุจุจุฑุฏ ู ุจุง ุฎุงู ุขุณูุฏู ู ูุงุดูุงุณ ุฏุฑ ุงูุชุฑูุช ฺฏุดุชโูฺฏุฐุงุฑ ฺฉูุฏ! ๐ฅท๐ป"
                ]);
                Telegram::api('sendMessage',[
                    'chat_id' => $referrer_chat_id,
                    'text' => "ุชุดฺฉุฑ ูฺู ุงุฒ ุดูุง! ๐๐
ุจุง ูุนุฑู ูุฒูุชุ ูุดูู ุฏุงุฏุฏ ฺฉู ููุดู ุจูุชุฑูโูุง ุฑู ุจุฑุง ุฏูุณุชุงุชูู ูโุฎูุงุฏ. ๐๐ท
ุญุงูุง ุจูู ูู ูุซู ุดูุง ูโุชููู ูุฐุช ู ุงูุชุฑูุช ุญุฑููโุง ู ุณุฑุน ุฑู ุชุฌุฑุจู ฺฉููุฏ. ๐
ุญุถูุฑ ุดูุง ุจุฑุง ูุง ุงุฑุฒุดููุฏ ุงุณุช. ๐"
                ]);
            }
        } else {
            Telegram::api('sendMessage',[
                'chat_id' => $update->chat_id,
                'text' => "ุฏุฑูุฏ! ๐
    ุจู ุฑุจุงุช ุชูฺฏุฑุงู ูุฒูุช ุฎูุด ุขูุฏุฏ. ุจุง ุงุณุชูุงุฏู ุงุฒ ุฏฺฉููโูุง ุฒุฑ ูโุชูุงูุฏ ุจุง ุณุฑูุณโูุง VPN ูุง ุขุดูุง ุดูุฏ ู ุจู ุตูุฑุช ูุงุดูุงุณ ุฏุฑ ุงูุชุฑูุช ฺฏุดุช ู ฺฏุฐุงุฑ ฺฉูุฏ ! ๐ฅท๐ป
    ฺฉุงู ุงุณุช ฺฉ ุงุฒ ฺฏุฒููโูุง ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ ู ุชุฌุฑุจู ุฌุฏุฏ ุฎูุฏ ุฑุง ุขุบุงุฒ ฺฉูุฏ! ๐๐"
            ]);
        }
    }
}